@page "/seller/orders"
@using Microsoft.AspNetCore.Authorization
@using Shopimoto.Application.Interfaces
@using Shopimoto.Domain.Entities
@attribute [Authorize(Roles = "Seller")]
@layout Shopimoto.Web.Components.Layout.SellerLayout
@inject IOrderService OrderService
@inject AuthenticationStateProvider AuthStateProvider
@rendermode InteractiveServer

<div class="d-flex align-items-center mb-4 fade-in">
    <a href="/seller/dashboard" class="btn btn-link text-decoration-none text-muted p-0 me-3">
        <i class="bi bi-arrow-left fs-4"></i>
    </a>
    <h1 class="h3 mb-0 text-gray-800">Manage Orders</h1>
</div>

@if (IsLoading)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (Orders == null || !Orders.Any())
{
    <div class="text-center py-5 animate-fade-in">
        <i class="bi bi-inbox text-muted opacity-25" style="font-size: 3rem;"></i>
        <p class="text-muted mt-3">No orders found yet.</p>
    </div>
}
else
{
    <div class="card shadow mb-4 animate-fade-in">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4 border-0">Order ID</th>
                            <th class="border-0">Date</th>
                            <th class="border-0">Customer</th>
                            <th class="border-0">Items (Yours)</th>
                            <th class="border-0">Total</th>
                            <th class="border-0">Status</th>
                            <th class="border-0 text-end pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var order in Orders)
                        {
                            <tr>
                                <td class="ps-4 fw-bold font-monospace text-primary">
                                    <small>#@order.Id.ToString().Substring(0, 8)</small>
                                </td>
                                <td class="small text-muted">@order.OrderDate.ToLocalTime().ToString("MMM dd, yyyy HH:mm")</td>
                                <td>
                                    <!-- We don't have direct Buyer name navigation property expanded usually, would need User Include in Repo -->
                                    <span class="d-block text-truncate" style="max-width: 150px;">
                                        BuyerID: @order.BuyerId.ToString().Substring(0,8)...
                                    </span>
                                </td>
                                <td>
                                    @foreach(var item in order.Items.Where(i => i.Product!.SellerId == SellerId))
                                    {
                                        <div class="d-flex align-items-center mb-1">
                                            <span class="badge bg-light text-dark border me-2">x @item.Quantity</span>
                                            <span class="text-truncate" style="max-width: 200px;">@item.Product!.Title</span>
                                        </div>
                                    }
                                </td>
                                <td class="fw-bold">
                                    @order.Items.Where(i => i.Product!.SellerId == SellerId).Sum(i => i.Quantity * i.UnitPrice).ToString("C")
                                </td>
                                <td>
                                    <span class="badge @GetStatusBadgeClass(order.Status)">
                                        @order.Status
                                    </span>
                                </td>
                                <td class="text-end pe-4">
                                     <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                            Update Status
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li><button class="dropdown-item" @onclick="() => UpdateStatus(order, OrderStatus.Processing)">Processing</button></li>
                                            <li><button class="dropdown-item" @onclick="() => UpdateStatus(order, OrderStatus.Shipped)">Shipped</button></li>
                                            <li><button class="dropdown-item" @onclick="() => UpdateStatus(order, OrderStatus.Delivered)">Delivered</button></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><button class="dropdown-item text-danger" @onclick="() => UpdateStatus(order, OrderStatus.Cancelled)">Cancelled</button></li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}

@code {
    private List<Order>? Orders;
    private Guid SellerId;
    private bool IsLoading = true;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
            if (userIdClaim != null && Guid.TryParse(userIdClaim.Value, out SellerId))
            {
                await LoadOrders();
            }
        }
        IsLoading = false;
    }

    private async Task LoadOrders()
    {
        Orders = await OrderService.GetSellerOrdersAsync(SellerId);
    }

    private async Task UpdateStatus(Order order, OrderStatus newStatus)
    {
        if (order.Status == newStatus) return;

        await OrderService.UpdateOrderStatusAsync(order.Id, newStatus);
        
        // Optimistic update
        order.Status = newStatus; 
        StateHasChanged();
    }

    private string GetStatusBadgeClass(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.Pending => "bg-warning text-dark",
            OrderStatus.Processing => "bg-info text-dark",
            OrderStatus.Shipped => "bg-primary",
            OrderStatus.Delivered => "bg-success",
            OrderStatus.Cancelled => "bg-danger",
            _ => "bg-secondary"
        };
    }
}
